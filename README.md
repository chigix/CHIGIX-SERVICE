千木服务架构
=======================

For ThinkPHP 3.1.0 +

Version 1.3.7

Author 千木郷（李颖豪） chigix@zoho.com

Facebook: http://facebook.com/chigix

Weibo: http://weibo.com/chigix

# Introduction

本架构旨在提供一个WEB快速开发的全新架构模式，基于经典的MVC架构进行一定的演变，使框架结构化的开发更加灵活与轻便，以松耦合、高内聚作为开发整体思想。

MVC架构是在软件开发中已占据不可动摇的地位，其架构模式的经典性与效力性无可质疑，而现在亦有大量优秀的成型的MVC框架，所以本架构不希望重复制造已存在的轮子，MVC架构使用现有的已足够。而本架构是基于MVC模式之上，提供一个项目部署与开发的整体方案——服务化方案。使得开发者不需再拘泥于MVC架构，更无需为架构而架构，一切的讨论与开发都由服务而来，一切的资源亦都是服务，有点类似于云计算中的一切皆服务思想（XaaS）。

## 关于2.0版本

现本架构尚于起步阶段，1.0版本定位于拥有完整的服务体系架构，可实现在服务体系下模块与模块间接交互，并尽可能多地开发基本服务，以使基于本架构能更便捷地开发出流行的web应用。

1.0版核心点还是在于单体应用的开发，而不在大规模集群和分布式应用的开发。

2.0版本的主要路线是开始由单体应用框架开始转移向集群分布式系统的定位，主要任务是提供暴露于外部WEB网络下的API接口，以实现模块与模块之间的分布式通信。

# Overview

通过本项目，开发者可以有一种更灵活更轻便的方式来部署和使用MVC架构，而开发在本架构中亦可进行如下两种开发：

1.	服务开发

	由于本框架是将所有的分层、架构均归为一个服务，所以架构本身只是一个解决方案，而部署具体的业务逻辑、开源业务逻辑则只需要将业务逻辑、应用逻辑本身当作服务来开发即可，而服务的作用就是实现系统的模块化拼装，服务与服务之间完全无依赖，在服务内只完成属于服务自己的业务逻辑和应用逻辑，而搭建的系统则是为服务之间建立起依赖关系。

2.	应用开发

	其实就是开发一个具体的项目，具体的系统，而基于服务架构的开发，只需要将自己系统所需的几个服务进行一下依赖的定义，完成服务组装，即可完成一套大型系统的开发项目。

本项目中已重构了框架中原生的Action控制器类，并为调试期间的工作提供了为本架构服务的模板引擎，虽然不会影响实际部署时的实现，但是毕竟是专为调试期间提供的服务，所以在部署模式时建议切换回ThinkPHP原生模式。

本架构仅仅是一个MVC开发的部署方案，也就说本质仍旧是依赖于原生的MVC框架，所以在千木服务架构与MVC架构之间是无缝切换的。而千木服务更大程度上是从调试阶段来考虑的。实际部署时，若不切换回原始的MVC框架，会有一定的性能影响。

# Getting Started

所有的源代码资源可参考sample目录下的文件，可以直接复制，参照里面的注释和格式进行修改即可。

在控制器中，`servcie("Chiji");` 是 `$this->display();` 的替代方案，Chiji（千路前端服务）可以说是本架构的一大亮点，将WEB开发中一个一直以来都非常头痛的问题当作一个服务来解决，开发者在前端与后端之间仅需要通过连接“千路前端”服务即可，而连接代码也仅此一句，无需作任何变动，亦无需考虑任何参数，直接连接完千路前端服务后，本架构中集成的千路前端服务会自动为开发者安排好所有的前端资源部署，而开发者在前端调用时，所有的资源只需从目录：`webRoot\Chiji\ProjectName\` 中获取即可。

在控制器中需要连接服务才能使用目标服务提供的方法和业务逻辑，而开发者几乎什么都不用做就可以开发出一个具有规模的系统。

连接服务亦非常简单，只需一句 `service("ServiceName")` 

**所有的service只能在客户端应用及客户端service中使用，不能在服务端Api及Model中使用。**

*注：现千路前端服务已脱离千木架构项目而作为一个独立项目存在，故关于千路服务的详细内容不在本文档中赘述。*

## Installation

本架构实为MVC框架的一个扩展机制，所以安装本架构就变得十分简单，在这里针对ThinkPHP 3.1.0 以上版本的安装进行说明：

直接在系统扩展目录（默认为webRoot/ThinkPHP/Extend/）下新建一个文件夹并命名为 `Chigi` ，直接将本仓库中的所有内容全部托入该文件夹中，即完成千木服务扩展的安装。

若要使用千木服务架构来设计应用，仅需在项目的别名配置（alias.php）中加入如下几行即可（可直接拷贝，无需改动）：

		//加载千木调试模板引擎
		//'ThinkTemplate' => EXTEND_PATH.'Chigi/ChigiTemplate.class.php',
		'ChigiAction' => EXTEND_PATH . 'Chigi/ChigiAction.class.php',
		'ChigiApi' => EXTEND_PATH . 'Chigi/ChigiApi.class.php',
		'ChigiService' => EXTEND_PATH . 'Chigi/ChigiService.class.php',

至此整个项目便可以完全使用千木服务架构来进行开发。

千木调试模板引擎默认是不启用的，所有继承ChigiAction类的控制器均可以连接及调用千木服务类。

关于千木调试模板引擎是千路服务项目中的一项内容，而千路前端服务现已作为一个独立的服务存在，脱离千木架构本体，所以详细的使用方法及资料请查看千路前端服务的相关文档。在这里只强调一点，若去掉上面的注释会启用千木调试模板引擎，而在该模板引擎下不允许使用display，必须通过连接千路前端服务来进行模板渲染和输出，否则会抛出异常。

### 控制器部署

1.	IndexAction	——所有直接显示的网页及显式URL访问的操作均在Index中，每个页面有各自对应的操作方法。
2.	EmptyAction	——空模块，主负责Service在URL访问下的安全包装
3.	AjaxAction	——ajax模块，主负责所有页面上异步交互的执行操作

### 模型部署

由于一切业务逻辑均服务化，所以对于一些主要的业务逻辑均已封装于已有的服务中，而对于已有服务提供的模型则无需作任何部署，直接连接到对应的Service类即可，在千木服务化架构下会替开发者完成所有本服务下的业务逻辑。

### 模板部署

由于在千木架构下，所有的模板都是直接采用与当前控制器及操作一一对应，故在控制器中只需 `$this->display()` 即可完成前端的输出，而不用开发者再作其他的工作。当然，这需要一个非常严格的模板目录部署机制，以做到 `display` 方法输出时可以直接定位及渲染模板。另外千路前端服务中会自动渲染CSS和JS并完成智能合并及压缩。详见千路前端服务ChijiService类的使用API。

模板目录Tpl下的文件部署如下：

		|-Tpl/Default               主题目录
		|        ├Index/            Index控制器下的页面渲染入口（即主模板文件）
		|        	├index.html     index页面主模板文件
		|        	├method.html    其他页面主模板文件
		|        ├Main/             Index:index操作的页面模块文件
		|        	├starter-module.html        Index:index页面的HTML起始模块
		|        	├starter-module.less        Index:index页面的全局样式定义
		|        	├starter-module.js          Index:index页面的起始脚本模块（通常用作全局脚本）
		|        ├Public    公用模板文件
		|        ├Utils     可移植服务接口模板文件
		|

### Widget部署

		|-Widget/				Widget扩展目录
		|     ├DemoServiceWidget.class.php    DemoService对应Widget类
		|     ├DemoService/                   DemoService对应Widget类调用模板目录
		|              ├method1.html          Widget类下method1操作对应模板文件
		|              ├demoMethod.html       DemoServiceWidget类下的demoMethod操作对应模板文件
		|     ├OtherServiceWidget.class.php   其他同样型的Widget类部署
		|

# 上线部署

App目录部署如下：

		|-Core/
		|-App/
		|   |-Common/
		|   |-Conf/
		|   |-Lang/
		|   |-Lib/
		|   |-Runtime/
		|   |-Tpl/
		|   |-.htaccess  ——直接将域名指向到App目录中，不同级别的域名则部署方式相同，无需改动PHP
		|   |-index.php  ——因为作为根目录，所以入口文件放置于目标域名的根目录下
		|
		...
		...
		|-Chiji/   ——建议直接建一个新域名指向该目录，所有静态资源文件均通过该域名来获取
		|    |-App/
		|    |   |-img/
		|    |   |-css/
		|    |   |-js/
		|    |
		|    |-Img/  ——作为图片服务的资源管理仓库
		|
		|

# 开发规范

## 返回值统一规范

在千木架构中，建议所有的方法或函数返回值均采用数组，示例格式如下：

		$return = array(
			'status' => 220,
			'info' => "获取文章id=13成功",
			'data' => array(
				"title" => "示例标题",
				"content" => "此处示例内容",
			),
		);

建议返回值格式须由 `status` 、 `info` 、`data` 三个元素组成：

1.	status：返回值的操作码，一个3位数的INT值，一切要包含的意义尽在这三位数中。
2.	info：返回官方型的返回信息，供调用本函数的开发者看，可以写一些建议，也可以写操作状态，是一个字符串。
3.	data：真正要返回的实体数据，即整个函数真正要返回的内容在这里

采用建议的返回值规范格式可以很方便地通过返回值处理服务ReturnService来接收返回值并进行智能处理和包装，方便开发与模块间开发的规范统一。提升开发体验。

关于status操作码，可参考最后所附的ChigiCode。

## CHING-SESSION会话机制

从1.2版本开始，提供CHING会话机制，该会话机制旨在分布式的会话实现，并作为PHP原生的SESSION机制的替代方案。

CHING会话机制提供开发者与SESSION几乎完全一样的使用方法，但是其内部的实现机制上直接提供了跨子域、无COOKIE跨页、多站会话共享等问题的解决。

现1.2版本中的CHING会话机制物理实现上仅处于物理文件读写方式，尚不支持内存加载与高速缓存，而这些缓存支持将在2.0+版本中提供支持。

### CHING会话部署

		/WebRoot/Core/  ——放置MVC框架内核
				/Ching/ ——放置CHING会话文件

一般网站按上述部署即可，在config.php中加入下面的设置项

		'SIDDOMAIN' => "five.com", //设置用户会话SID的作用域名

SID的CHING会话的暴露标识，用以让浏览器在页面切换之间可以继续上一页面的访问情况，关于SID则比session_id更加灵活与安全，SID可以通过COOKIE、GET、POST三种方式传递给服务器，为了安全起见，可以直接将CHING会话与用户挂钩。

从1.2.1版本开始，本框架会自动为所有访问者创建SID，包括游客，开发者则无需考虑SID的任何有关实现，只需直接操作用户会话即可。同时游客SID与SugarService下的用户加密SID完全兼容配合，不同类型的SID可以在SugarService下直接进行检测识别。

### ching()函数使用

ching会话在使用上与session完全一样，仅是普通的键值型数据的临时存储。

基本使用如下：

1.	`ching("newName",$newValue);`      设置新的ching会话值
2.	`ching()`                          获取当前全局ching会话内容（数组）
3.	`ching("name");`                   ching会话取值
4.	`ching("Array.Element1.Ele2")`     ching会话数组取值（1.3.0+）
5.	`ching("name",null)`               删除指定ching
5.	`ching(null)`                      清空当前ching（1.3.5+）

### 关于操作时效

CHING会话目前默认时效为15分钟，若需在项目配置文件中自定义，在1.4版本中提供实现。

**注意** 任何会话机制在底层都是有缓存方式在支持，所以规定会话的时效性十分重要，可以为服务器避免不必要的开销，另外可以直接根据文件的最后修改时间删除超过15分钟的文件，进行会话垃圾清理。

# API——ChigiAction

# API——ChigiApi

## $this->dm("TableName");

*	功能：返回目标数据模型，做到按需连接数据库查询，避免产生无用资源
*	参数：String，例如 `SugarMembers` 则指向 `sugar_members` 表
*	注意：使用dm函数获取的目标数据模型必须在当前Api子类中有对应的属性，且属性中写明要连接的数据模型地址，例如：

		public $dmTableName = "Project://TableName";  //设置目标数据模型地址，必须为public，否则报错
		public function test(){
			$this->dm("TableName");  //获取目标数据模型
		}

*	版本：1.4.0+

# ChigiCode

## 第一位数说明

*	`0` ——保留数值，留空
*	`2` ——函数执行正常，返回成功信息
*	`4` ——函数本体执行正常，返回业务逻辑上的失败信息
*	`5` ——函数本体执行失败，即应用逻辑上出错，主要有 `脚本错误` 和 `数据库查询错误` 两种

## 第二位数说明

*	`0` ——函数执行中断，无返回讨论
*	`1` ——数值型返回
*	`2` ——字符串返回
*	`3` ——数组型返回
*	`4` ——布尔型返回
*	`5` ——无返回，返回数据为null
*	`6` ——对象型返回

## 第三位数说明

*	`1` ——一般返回数据，无附加说明
*	`2` ——抛出_404()
*	`3` ——返回数据库查询错误信息
*	`4`	——注入COOKIE→返回数据必须为一个二元素或三元素的关联数组
*	`5` ——注入CHING→返回数据必须为一个双元素关联数组
*	`6` ——返回数据作为输出信息（默认是使用info作为输出信息）
*	`7` ——注入SESSION→返回数据必须为一个双元素关联数组

## 具体代码说明

*	`000` ——留空，表示未定义
*	`211` ——执行正常，返回为数值，一般返回数据，无附加说明
*	`221` ——执行正常，返回为字符串，一般返回数据，无附加说明
*	`226` ——执行正常，返回字符串内容作为messageSuccess内容
*	`231` ——执行正常，返回为数组，一般返回数据，无附加说明
*	`234` ——执行正常，返回array("tag","data")，并注入COOKIE
*	`235` ——执行正常，返回array("tag","data")，并注入CHING
*	`236` ——执行正常，返回字符串内容作为messageSuccess内容
*	`237` ——执行正常，返回array("tag","data")，并注入SESSION
*	`241` ——执行正常，返回为布尔，一般返回数据，无附加说明
*	`251` ——执行正常，没有返回，返回数据为null
*	`261` ——执行正常，返回为对象，一般返回数据，无附加说明
*	`401` ——业务失败，函数执行中断，无返回讨论
*	`402` ——业务失败，业务逻辑上中断脚本运行，并抛出_404()
*	`411` ——业务失败，返回数值，一般返回数据，无附加说明
*	`421` ——业务失败，返回字符串，一般返回数据，无附加说明
*	`426` ——业务失败，返回字符串内容作为messageError内容
*	`427` ——业务失败，返回array("tag","data")，并注入SESSION
*	`431` ——业务失败，返回数组，一般返回数据，无附加说明
*	`441` ——业务失败，返回布尔值，一般返回数据，无附加说明
*	`451` ——业务失败，void返回，返回数据为null
*	`501` ——函数执行中断，应用逻辑错误，不作任何附加处理
*	`502` ——函数执行中断，抛出_404()
*	`523` ——数据库查询出错，返回数据库查询错误信息内容
*	`526` ——程序执行出错，返回字符串作为messageError内容
